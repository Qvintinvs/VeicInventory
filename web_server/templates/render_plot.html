<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>NetCDF Heatmap Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <h1 id="title">NetCDF Heatmap Visualization</h1>
    <div class="container mt-5 d-flex flex-row">
        <div class="dropdown me-3">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
                data-bs-toggle="dropdown" aria-expanded="false">
                Select a Key
            </button>
            <ul class="dropdown-menu overflow-auto" id="dropdownMenu" style="max-height: 200px">
            </ul>
        </div>
        <label for="delayRange">Delay (ms):</label>
        <input type="range" id="delayRange" min="0" max="1000" step="10" value="0">
        <span id="delayValue">0 ms</span>

    </div>
    <div id="heatmap" style="width: 100%; height: 600px;"></div>

    <script>
        const delayRange = document.getElementById("delayRange")
        let currentFrame = 0
        let isPaused = false
        let isCycle = true
        let lastFrame
        let frames = []
        let targetVars
        let selectedVar = "CO2_BIO"
        let intervalId = null
        let delay = parseInt(delayRange.value)
        
        async function fetchAndPlotHeatmap() {
            try {
                // Fetch the data from the Flask backend

                if (intervalId) {
                    clearInterval(intervalId)
                }
                intervalId = null

                const response = await fetch(`/get_netcdf_data${selectedVar ? `?data_variable=${selectedVar}` : ''}`);
                const data = await response.json();

                // Extract data from the JSON response
                const lats = data.lats
                const lons = data.lons
                frames = data.frames
                targetVars = data.target_vars
                lastFrame = frames.length

                // Initialize the heatmap with the first frame
                const initialFrame = frames[0];

                // Prepare Plotly data
                const plotData = [
                    {
                        z: initialFrame, // First time step's data
                        x: lons[0], // Longitude grid
                        y: lats.map(row => row[0]), // Latitude grid
                        type: 'heatmap',
                        colorscale: 'Viridis',
                        colorbar: {
                            title: 'CO2 Mixing Ratio (ppmv)'
                        }
                    }
                ];

                // Prepare layout
                const layout = {
                    title: `Visualizing ${selectedVar}`,
                    xaxis: {
                        title: 'Longitude'
                    },
                    yaxis: {
                        title: 'Latitude'
                    }
                };

                // Initialize the heatmap
                Plotly.newPlot('heatmap', plotData, layout);

                // Animate through frames
                intervalId = setInterval(() => {
                    const frameData = frames[currentFrame + 1]

                    // Update the heatmap with new frame data
                    Plotly.update('heatmap', {
                        z: [frameData] // Update heatmap data
                    });
                    if (currentFrame + 1 === frames.length && (!isPaused || isCycle)) {
                        console.log("got here lol")
                        // document.body.dispatchEvent(new KeyboardEvent(("keydown", { code: "Space" })))
                        isPaused = !isPaused
                    }
                    if (isPaused) {
                        return
                    }

                    currentFrame = (currentFrame + 1) % frames.length; // Loop through frames
                    console.log(`currentFrame: ${currentFrame}`)

                }, delay)
            } catch (error) {
                console.error('Error fetching or plotting NetCDF data:', error);
            }

            const dropdownMenu = document.getElementById("dropdownMenu")

            dropdownMenu.innerHTML = ""
            targetVars.forEach(key => {
                const item = document.createElement("li")
                item.innerHTML = `<a class="dropdown-item" href="#">${key.trim()}</a>`

                item.querySelector("a").addEventListener("click", () => {
                    updateSelectedVar(key.trim())
                })

                dropdownMenu.appendChild(item)
            })
        }

        // let iframe = document.getElementById("body")
        document.body.addEventListener("keydown", (e) => {
            // e.preventDefault()
            // handleKeyDown(e)
            console.log(e.code)
            if (e.code === "Space") {
                e.preventDefault()
                isPaused = !isPaused
                console.log("isPaused:", isPaused)
                console.log("currentFrame:", currentFrame)

                if (!isPaused && currentFrame + 1 === lastFrame) {
                    currentFrame = 0
                    isPaused = false
                }

            }

            if (e.code === "ArrowLeft") {
                (currentFrame > 0) ? currentFrame-- : currentFrame = 0
                console.log("currentFrame:", currentFrame)
            }

            if (e.code === "ArrowRight") {
                (currentFrame < lastFrame) ? currentFrame++ : currentFrame = lastFrame
                console.log("currentFrame:", currentFrame)
            }

            if (e.code === "KeyC") {
                isCycle = !isCycle
                console.log(`isCycle: ${isCycle}`)
            }
        })

        delayRange.addEventListener("input", function () {
        delay = parseInt(this.value);
        document.getElementById("delayValue").textContent = `${delay} ms`;

            if (intervalId) {
                clearInterval(intervalId);
            }

            intervalId = setInterval(() => {
                const frameData = frames[currentFrame + 1]

                // Update the heatmap with new frame data
                Plotly.update('heatmap', {
                    z: [frameData] // Update heatmap data
                });
                if (currentFrame + 1 === frames.length && (!isPaused || isCycle)) {
                    console.log("got here lol")
                    // document.body.dispatchEvent(new KeyboardEvent(("keydown", { code: "Space" })))
                    isPaused = !isPaused
                }
                if (isPaused) {
                    return
                }

                currentFrame = (currentFrame + 1) % frames.length; // Loop through frames
                console.log(`currentFrame: ${currentFrame}`)

            }, delay)

        })

        fetchAndPlotHeatmap()

        $(document).ready(function () {
            $('#visualizeModal').on('hidden.bs.modal', function () {
                $('#iframeId').attr('src', $('#iframeId').attr('src'))
                isPaused = true
            })

            $('#visualizeModal').on('shown.bs.modal', function () {
                isPaused = false
            })
        })

        function updateSelectedVar(newVar) {
            selectedVar = newVar
            console.log(`selectedVar changed to: ${selectedVar}`)
            fetchAndPlotHeatmap() // Fetch new data and update the plot
        }

        function getVariables() {
            return targetVars
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>