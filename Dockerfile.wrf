# ==============================
# ðŸ—ï¸ Stage 1 â€” Base mÃ­nima de compilaÃ§Ã£o
# ==============================
FROM ubuntu:22.04 AS base

ENV DEBIAN_FRONTEND=noninteractive

# ðŸ”§ Ferramentas bÃ¡sicas (compiladores e utilitÃ¡rios)
RUN apt-get update && apt-get install -y \
    build-essential gfortran g++ gcc m4 make cmake \
    perl csh tcsh wget git curl time gawk file \
    binutils coreutils findutils tar grep sed util-linux \
    && rm -rf /var/lib/apt/lists/*

ENV PATH=/opt/wrf-bin:$PATH \
    LD_LIBRARY_PATH=/usr/local/lib:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH \
    CPPFLAGS="-I/usr/include -I/usr/include/hdf5/serial" \
    LDFLAGS="-L/usr/lib/x86_64-linux-gnu"

# ==============================
# ðŸ§± Stage 2 â€” DependÃªncias cientÃ­ficas (NetCDF, Jasper, HDF5)
# ==============================
FROM base AS deps

# âš™ï¸ Libs cientÃ­ficas e paralelismo
RUN apt-get update && apt-get install -y \
    mpich libmpich-dev openmpi-bin libopenmpi-dev \
    libpng-dev zlib1g-dev libcurl4-openssl-dev \
    libhdf5-dev libhdf5-serial-dev \
    libnetcdf-dev libnetcdff-dev \
    && rm -rf /var/lib/apt/lists/*

# ðŸ“¦ Compila e instala Jasper (com cache persistente BuildKit)
WORKDIR /opt/libs
RUN --mount=type=cache,target=/opt/cache \
    wget https://github.com/mdadams/jasper/archive/refs/tags/version-2.0.33.tar.gz -O jasper.tar.gz && \
    tar -xf jasper.tar.gz && \
    cd jasper-* && \
    cmake -G "Unix Makefiles" -Bbuild -DCMAKE_INSTALL_PREFIX=/usr/local . && \
    cmake --build build --target install && \
    ldconfig && \
    cd / && rm -rf /opt/libs

ENV JASPERLIB=/usr/local/lib \
    JASPERINC=/usr/local/include

# ==============================
# ðŸŒ€ Stage 3 â€” Build do WRF
# ==============================
FROM deps AS build

RUN apt-get update && apt-get install -y \
    python3-minimal \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /opt
RUN git clone --depth=1 https://github.com/wrf-model/WRF.git

WORKDIR /opt/WRF
RUN cp share/landread.c.dist share/landread.c

# ðŸŒŽ VariÃ¡veis de ambiente do NetCDF
ENV NETCDF_CLASSIC=1 \
    NETCDF=/usr \
    NETCDF_C=/usr \
    NETCDF_FORTRAN=/usr

# âš™ï¸ Configura e compila
RUN --mount=type=cache,target=/opt/cache/wrf-build \
    --mount=type=tmpfs,target=/tmp/wrf-tmp \
    printf '35\n1\n' | ./configure -r8 && \
    echo "ðŸš€ Compilando WRF..." && \
    TMPDIR=/tmp/wrf-tmp ./compile em_real 2>&1 | tee /opt/WRF/compile.log && \
    echo "ðŸ§© Verificando resultados da compilaÃ§Ã£o..." && \
    ls -lh main || true && \
    echo "ðŸ’¾ Sincronizando build cache..." && \
    rsync -a main/ /opt/cache/wrf-build/main/ || true

# ==============================
# ðŸš€ Stage 4 â€” Runtime
# ==============================
FROM ubuntu:22.04 AS runtime

ENV DEBIAN_FRONTEND=noninteractive

# SÃ³ dependÃªncias de execuÃ§Ã£o (sem toolchain)
RUN apt-get update && apt-get install -y \
    libnetcdf-dev libnetcdff-dev libhdf5-serial-dev libpng-dev zlib1g-dev mpich openmpi-bin \
    && rm -rf /var/lib/apt/lists/*

# Jasper
COPY --from=deps /usr/local/lib /usr/local/lib
COPY --from=deps /usr/local/include /usr/local/include

WORKDIR /opt/WRF

# Copia apenas os binÃ¡rios e o log do build
COPY --from=build /opt/WRF/main/*.exe /opt/WRF/main/
COPY --from=build /opt/WRF/run /opt/WRF/run
COPY --from=build /opt/WRF/phys/noahmp/parameters/MPTABLE.TBL /opt/WRF/phys/noahmp/parameters/MPTABLE.TBL

ENV PATH=/usr/WRF/main:$PATH \
    LD_LIBRARY_PATH=/usr/local/lib:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH

# ENTRYPOINT ["/opt/wrf-bin/wrf.exe"]
ENTRYPOINT ["bash"]